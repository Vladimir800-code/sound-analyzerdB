<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>–ê–Ω–∞–ª–∏–∑–∞—Ç–æ—Ä –∑–≤—É–∫–∞ (–¥–ë SPL)</title>
<style>
  :root { --blue:#2563eb; --blue-dark:#1e40af; --grid:#e5e7eb; --text:#111827; --muted:#6b7280; }
  * { box-sizing: border-box; }
  body {
    font-family: Arial, sans-serif;
    color: var(--text);
    background: linear-gradient(to bottom, #f0f4f8, #dbeafe);
    margin: 0; padding: 0; text-align: center;
  }
  header { padding: 18px 12px 6px; }
  h1 { margin: 0 0 8px; color:#1e3a8a; font-size: 22px; }
  .controls { margin: 8px 0 4px; display:flex; gap:8px; justify-content:center; flex-wrap: wrap; }
  button {
    padding: 10px 16px; font-size: 15px; border: none; border-radius: 10px;
    background: var(--blue); color:#fff; cursor:pointer; transition: background .25s ease, transform .05s ease;
  }
  button:hover { background: var(--blue-dark); }
  button:active { transform: translateY(1px); }
  button:disabled { background:#94a3b8; cursor: not-allowed; }
  #status { min-height: 22px; font-weight: 600; margin: 8px 0 0; color:#0f172a; }
  #status.error { color:#b91c1c; }
  #status.ok { color:#065f46; }
  main { padding: 10px 12px 30px; }
  canvas {
    display:block; margin: 12px auto 0; background:#fff; border:1px solid #000;
    max-width: 95vw; height:auto;
  }
  .hint { color: var(--muted); font-size: 13px; margin-top: 6px; }
</style>
</head>
<body>
<header>
  <h1>–ê–Ω–∞–ª–∏–∑ –∏–Ω—Ç–µ–Ω—Å–∏–≤–Ω–æ—Å—Ç–∏ –∑–≤—É–∫–∞ (–¥–ë SPL)</h1>
  <div class="controls">
    <button id="calibrateBtn">üìè –ö–∞–ª–∏–±—Ä–æ–≤–∫–∞</button>
    <button id="startBtn">üéô –ù–∞—á–∞—Ç—å –∑–∞–ø–∏—Å—å (10 —Å)</button>
    <button id="resetCalBtn" title="–£–¥–∞–ª–∏—Ç—å —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—É—é –∫–∞–ª–∏–±—Ä–æ–≤–∫—É">‚ôªÔ∏è –°–±—Ä–æ—Å –∫–∞–ª–∏–±—Ä–æ–≤–∫–∏</button>
  </div>
  <div id="status" aria-live="polite"></div>
  <div class="hint">–°–Ω–∞—á–∞–ª–∞ –≤—ã–ø–æ–ª–Ω–∏—Ç–µ ¬´–ö–∞–ª–∏–±—Ä–æ–≤–∫–∞¬ª. –í–∞—à–∞ –∫–∞–ª–∏–±—Ä–æ–≤–∫–∞ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –≤ –±—Ä–∞—É–∑–µ—Ä–µ (localStorage).</div>
</header>
<main>
  <canvas id="graph" width="900" height="420"></canvas>
</main>

<script>
(() => {
  const startBtn = document.getElementById('startBtn');
  const calibrateBtn = document.getElementById('calibrateBtn');
  const resetCalBtn = document.getElementById('resetCalBtn');
  const status = document.getElementById('status');
  const canvas = document.getElementById('graph');
  const ctx = canvas.getContext('2d');

  const DURATION = 10;       // —Å–µ–∫—É–Ω–¥ –∑–∞–ø–∏—Å–∏
  const CHUNK_SIZE = 1024;   // –æ–∫–Ω–æ –¥–ª—è RMS
  let audioData = [];

  let audioContext = null;
  let sourceNode = null;
  let scriptProcessor = null;
  let currentStream = null;
  let recordTimer = null;
  let isRecording = false;

  let K = parseFloat(localStorage.getItem('calibrationK') || 'NaN');
  if (isFinite(K) && K > 0) {
    setStatus('–ù–∞–π–¥–µ–Ω–∞ —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω–∞—è –∫–∞–ª–∏–±—Ä–æ–≤–∫–∞.', 'ok');
  } else {
    K = NaN;
    setStatus('–°–Ω–∞—á–∞–ª–∞ –≤—ã–ø–æ–ª–Ω–∏—Ç–µ ¬´–ö–∞–ª–∏–±—Ä–æ–≤–∫–∞¬ª.', '');
  }

  if (location.protocol !== 'https:' && location.hostname !== 'localhost') {
    setStatus('‚ö† –ó–∞–ø—É—Å—Ç–∏—Ç–µ —á–µ—Ä–µ–∑ HTTPS –∏–ª–∏ GitHub Pages –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –º–∏–∫—Ä–æ—Ñ–æ–Ω–æ–º.', 'error');
    startBtn.disabled = true;
    calibrateBtn.disabled = true;
  }

  function setStatus(text, cls='') {
    status.className = cls ? cls : '';
    status.textContent = text;
  }

  function setButtonsDisabled(disabled) {
    startBtn.disabled = disabled;
    calibrateBtn.disabled = disabled;
    resetCalBtn.disabled = disabled && !isFinite(K);
  }

  function getRMS(arr) {
    if (!arr || arr.length === 0) return 0;
    let s = 0;
    for (let i = 0; i < arr.length; i++) s += arr[i] * arr[i];
    return Math.sqrt(s / arr.length);
  }

  async function recordAudio(seconds, onDone) {
    if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
      setStatus('‚ùå –í–∞—à –±—Ä–∞—É–∑–µ—Ä –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç —Ä–∞–±–æ—Ç—É —Å –º–∏–∫—Ä–æ—Ñ–æ–Ω–æ–º.', 'error');
      return;
    }
    if (isRecording) await stopRecording();

    try {
      setStatus('üîç –ó–∞–ø—Ä–æ—Å –¥–æ—Å—Ç—É–ø–∞ –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É...');
      audioData = [];
      isRecording = true;
      setButtonsDisabled(true);

      currentStream = await navigator.mediaDevices.getUserMedia({ audio: true });
      audioContext = new (window.AudioContext || window.webkitAudioContext)();
      await audioContext.resume();

      sourceNode = audioContext.createMediaStreamSource(currentStream);
      scriptProcessor = audioContext.createScriptProcessor(CHUNK_SIZE, 1, 1);
      scriptProcessor.onaudioprocess = (event) => {
        const input = event.inputBuffer.getChannelData(0);
        audioData.push(...input);
      };

      sourceNode.connect(scriptProcessor);
      scriptProcessor.connect(audioContext.destination);

      setStatus('üé§ –ò–¥—ë—Ç –∑–∞–ø–∏—Å—å...');

      recordTimer = setTimeout(async () => {
        await stopRecording();
        if (typeof onDone === 'function') onDone();
      }, Math.max(0, seconds * 1000));

    } catch (err) {
      console.error(err);
      setStatus('–û—à–∏–±–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É: ' + (err && err.message ? err.message : err), 'error');
      await stopRecording();
    }
  }

  async function stopRecording() {
    if (!isRecording) return;
    isRecording = false;
    try {
      if (recordTimer) { clearTimeout(recordTimer); recordTimer = null; }
      if (scriptProcessor) { scriptProcessor.disconnect(); scriptProcessor.onaudioprocess = null; }
      if (sourceNode) { sourceNode.disconnect(); }
      if (currentStream) currentStream.getTracks().forEach(t => t.stop());
      if (audioContext) await audioContext.close();
    } catch (e) {
      console.warn('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Å—Ç–∞–Ω–æ–≤–∫–µ –∑–∞–ø–∏—Å–∏:', e);
    } finally {
      scriptProcessor = null;
      sourceNode = null;
      currentStream = null;
      audioContext = null;
      setButtonsDisabled(false);
      setStatus('–ó–∞–ø–∏—Å—å –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞.');
    }
  }

  calibrateBtn.addEventListener('click', async () => {
    alert('–°–∫–∞–∂–∏—Ç–µ —á—Ç–æ-—Ç–æ –≤—Å–ª—É—Ö –∏–ª–∏ —Ö–ª–æ–ø–Ω–∏—Ç–µ –≤ –ª–∞–¥–æ—à–∏ –Ω–∞ —Ä–∞—Å—Å—Ç–æ—è–Ω–∏–∏ ~30 —Å–º –æ—Ç –º–∏–∫—Ä–æ—Ñ–æ–Ω–∞.\n–ö–∞–ª–∏–±—Ä–æ–≤–∫–∞ –¥–ª–∏—Ç—Å—è 3 —Å–µ–∫—É–Ω–¥—ã.');
    await recordAudio(3, () => {
      const rms = getRMS(audioData);
      if (!rms || rms <= 1e-6) {
        setStatus('‚ö† –û—á–µ–Ω—å –Ω–∏–∑–∫–∏–π —Å–∏–≥–Ω–∞–ª –≤–æ –≤—Ä–µ–º—è –∫–∞–ª–∏–±—Ä–æ–≤–∫–∏. –ü–æ–≤—Ç–æ—Ä–∏—Ç–µ.', 'error');
        return;
      }
      const L_ref = 65;
      const P_ref = 20e-6 * Math.pow(10, L_ref / 20);
      K = P_ref / rms;
      localStorage.setItem('calibrationK', String(K));
      setStatus(`‚úÖ –ö–∞–ª–∏–±—Ä–æ–≤–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞. K = ${K.toExponential(3)} –ü–∞/–µ–¥.`, 'ok');
    });
  });

  resetCalBtn.addEventListener('click', () => {
    localStorage.removeItem('calibrationK');
    K = NaN;
    setStatus('–ö–∞–ª–∏–±—Ä–æ–≤–∫–∞ —Å–±—Ä–æ—à–µ–Ω–∞. –í—ã–ø–æ–ª–Ω–∏—Ç–µ ¬´–ö–∞–ª–∏–±—Ä–æ–≤–∫–∞¬ª –ø–µ—Ä–µ–¥ –∏–∑–º–µ—Ä–µ–Ω–∏–µ–º.', '');
  });

  startBtn.addEventListener('click', async () => {
    if (!isFinite(K) || K <= 0) {
      alert('–°–Ω–∞—á–∞–ª–∞ –≤—ã–ø–æ–ª–Ω–∏—Ç–µ –∫–∞–ª–∏–±—Ä–æ–≤–∫—É.');
      return;
    }
    await recordAudio(DURATION, processAudio);
  });

  function processAudio() {
    if (!audioData || audioData.length === 0) {
      setStatus('‚ùå –ó–≤—É–∫ –Ω–µ –∑–∞–ø–∏—Å–∞–Ω.', 'error');
      return;
    }
    const dbValues = [];
    for (let i = 0; i < audioData.length; i += CHUNK_SIZE) {
      const chunk = audioData.slice(i, i + CHUNK_SIZE);
      const rms = getRMS(chunk);
      const P = Math.max(rms * K, 1e-12);
      const dB = 20 * Math.log10(P / 20e-6);
      dbValues.push(dB);
    }
    drawGraph(dbValues);
    setStatus('‚úÖ –ì—Ä–∞—Ñ–∏–∫ –ø–æ—Å—Ç—Ä–æ–µ–Ω!', 'ok');
  }

  function drawGraph(dbValues) {
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    let maxDb = Math.max(...dbValues);
    let minDb = Math.min(...dbValues);
    if (!isFinite(maxDb) || !isFinite(minDb)) { maxDb = -20; minDb = -80; }
    const padding = 5;
    maxDb = Math.ceil((maxDb + padding) / 5) * 5;
    minDb = Math.floor((minDb - padding) / 5) * 5;
    if (maxDb - minDb < 20) {
      const mid = (maxDb + minDb) / 2;
      maxDb = mid + 10; minDb = mid - 10;
    }

    ctx.strokeStyle = getComputedStyle(document.documentElement).getPropertyValue('--grid') || '#e5e7eb';
    ctx.lineWidth = 1;
    ctx.font = '12px Arial';
    ctx.fillStyle = '#555';
    for (let db = Math.ceil(minDb/10)*10; db <= maxDb; db += 10) {
      const y = mapDbToY(db, minDb, maxDb);
      ctx.beginPath(); ctx.moveTo(0, y); ctx.lineTo(canvas.width, y); ctx.stroke();
      ctx.fillText(db + ' –¥–ë', 6, y - 2);
    }

    const N = dbValues.length;
    for (let t = 0; t <= DURATION; t++) {
      const x = (t / DURATION) * canvas.width;
      ctx.beginPath(); ctx.moveTo(x, 0); ctx.lineTo(x, canvas.height); ctx.stroke();
      ctx.fillText(t + ' —Å', x + 3, canvas.height - 6);
    }

    ctx.beginPath();
    const denom = Math.max(1, N - 1);
    for (let i = 0; i < N; i++) {
      const x = (i / denom) * canvas.width;
      const y = mapDbToY(dbValues[i], minDb, maxDb);
      if (i === 0) ctx.moveTo(x, y); else ctx.lineTo(x, y);
    }
    ctx.strokeStyle = getComputedStyle(document.documentElement).getPropertyValue('--blue') || '#2563eb';
    ctx.lineWidth = 2; ctx.stroke();

    ctx.strokeStyle = '#000';
    ctx.beginPath(); ctx.moveTo(0, 0); ctx.lineTo(0, canvas.height);
    ctx.moveTo(0, canvas.height); ctx.lineTo(canvas.width, canvas.height); ctx.stroke();

    ctx.font = '14px Arial'; ctx.fillStyle = '#000';
    ctx.fillText('–í—Ä–µ–º—è (—Å)', canvas.width / 2 - 35, canvas.height - 10);
    ctx.save(); ctx.rotate(-Math.PI / 2);
    ctx.fillText('–£—Ä–æ–≤–µ–Ω—å –∑–≤—É–∫–∞ (–¥–ë SPL)', -canvas.height / 2 - 55, 15);
    ctx.restore();
  }

  function mapDbToY(value, minDb, maxDb) {
    const frac = (value - minDb) / (maxDb - minDb);
    return canvas.height - frac * canvas.height;
  }

  window.addEventListener('beforeunload', () => { if (isRecording) stopRecording(); });
})();
</script>
</body>
</html>
